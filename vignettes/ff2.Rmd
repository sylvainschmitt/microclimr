---
title: "ff2"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ff2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(microclimr)
library(dplyr)
library(ggplot2)
```

# Functions

Return the Fourier coefficient of a real 's' from FFT in complex form, with normalization

```{r fft_rfft}
fft_rfft <- function(data) {
  n <- length(data)
  l <- ifelse(n %% 2 == 0,
    (n %/% 2 + 1),
    ((n + 1) %/% 2)
  )
  sp <- fft(data)[1:l] / n
  sp[2:l] <- sp[2:l] * 2
  return(sp)
}
```

Return the frequencies for a real signal of length T (in time) with N samples

```{r fft_freq}
fft_freq <- function(n, t) {
  seq(1, n %/% 2) / t
}
```

Return the periods for a real signal of length T (in time) with N samples

```{r fft_period}
fft_period <- function(freq) {
  1 / freq
}
```

Return the mean temperature

```{r fft_mean}
fft_mean <- function(sp) {
  Re(sp[1])
}
```

Return the powers

```{r fft_powers}
fft_powers <- function(sp) {
  abs(sp[2:length(sp)])
}
```

Return the energy

```{r fft_energy}
fft_energy <- function(sp) {
  sum(abs(sp[2:length(sp)])**2) / 2 + Re(sp[1])**2
}
```

Return the delay per frequencies

```{r fft_delay}
fft_delay <- function(sp, freq) {
  Arg(sp[2:length(sp)]) / (2 * pi * freq)
}
```

Reconstruct the temperatures at time t, whose spectrum is 'sp' associate to frequencies 'freq'

```{r fft_reconstruct}
fft_reconstruct <- function(sp, freq, time) {
  s <- Re(sp[1])
  for (n in seq_along(freq)) {
    s <- s + Re(sp[n + 1]) * cos(2 * pi * freq[n] * time) -
      Im(sp[n + 1]) * sin(2 * pi * freq[n] * time)
  }
  return(s)
}
```

# Test

```{r test}
t <- 10
n <- 201
time <- seq(0, n - 1) * t / n
temp <- 14 +
  0.5 * cos(2 * pi * (time - 0.5) * 2 / t) +
  3 * cos(2 * pi * (time - 0.1) * 4 / t) + 0.3 * rnorm(n)

sp <- fft_rfft(temp)
freq <- fft_freq(n, t)

tt <- seq(0, t, by = 0.01)
s <- fft_reconstruct(sp, freq, tt)

tibble(time = tt, s) %>%
  ggplot(aes(time, s)) +
  geom_line() +
  geom_point(aes(y = temp), data = tibble(time, temp)) +
  theme_bw()
```

