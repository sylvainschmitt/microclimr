---
title: "fft"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{fft}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
datetime <- NA
```

```{r setup}
#| message: false
library(microclimr)
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
library(runner)
```

# Data load

```{r}
data <- era %>%
  rename(era = tas, datetime = time) %>%
  select(datetime, era) %>%
  left_join(select(hobo, datetime, t_hobo) %>%
    rename(hobo = t_hobo)) # nolint
```

## Data check

Check hours that are lacking

```{r}
for (i in 1:(nrow(data) - 1)) {
  if (data$datetime[i + 1] - data$datetime[i] > as.difftime(1, units = "hours")) { # nolint
    print(i)
  }
}
```

Here is a problem at summer time? To discuss!

```{r}
print(data[2015:2020, ])
```

After correction:

```{r}
data$datetime[2019] <- data$datetime[2019] - as.difftime(1, units = "hours")
print(data[2015:2020, ])
```

Here is lacking 10 hours:

```{r}
data[6920:6927, ]
```

```{r}
data <- data %>%
  pivot_longer(
    cols = era:hobo,
    names_to = "source",
    values_to = "temperature"
  ) %>%
  mutate(season = ifelse(month(datetime) %in% 5:11, "leaf-on", "leaf-off")) %>%
  arrange(source, season, datetime)
```

# Data

# FFT

Decomposition of Fourier coefficients on 5 days.

```{r}
n <- 5 * 24
date1 <- as_datetime("2023-07-02 00:00:00")
date2 <- as_datetime("2023-07-06 23:00:00")
data %>%
  filter(
    datetime >= date1,
    datetime <= date2
  ) %>%
  group_by(source) %>%
  summarise(fft = list(fft_tab(temperature, 5 * 24))) %>%
  unnest(fft) %>%
  ggplot(aes(frequency, power, fill = source)) +
  geom_col(position = "dodge") +
  theme_bw() +
  ggtitle("Representation of power spectrum (window 5days)") +
  xlab("Period [h]") +
  ylab("Power") +
  scale_x_continuous(
    breaks = c(0, 1 / 24, 1 / 12, 1 / 8, 1 / 6, 1 / 3),
    labels = c("0", "24", "12", "8", "6", "3")
  ) +
  scale_fill_manual("", values = c("#e4c284", "#4a8b76")) +
  theme(legend.position.inside = c(0.8, 0.8)) +
  scale_y_sqrt()
```

Decomposition of Fourier coefficients using a sliding window with `fft_roll`.

```{r}
fc_all <- data %>%
  group_by(source, season) %>%
  do(fft = fft_roll(
    data = .,
    t = n,
    index_col = "datetime",
    temperature_col = "temperature",
    window = "5 days",
    step = "3 days"
  )) %>%
  unnest(fft)
```

Usage example. The 0 frequency is the mean!

```{r}
fc_all %>%
  filter(period == 0) %>%
  select(season, source, datetime, power) %>%
  pivot_wider(names_from = source, values_from = power) %>%
  ggplot(aes(era, hobo, col = season)) +
  geom_point() +
  geom_smooth(method = "lm", formula = " y ~ x") +
  theme_bw() +
  scale_color_manual("Period", values = c("#816768", "#68ae72")) +
  xlab("ERA5-Land temperature [째C]") +
  ylab("HOBO temperature [째C]") +
  coord_equal() +
  theme(legend.position = "bottom") +
  ggtitle("Mean temperature")
```

The 5 frequency is the period 24:

```{r}
fc_all %>%
  filter(period == 24) %>%
  select(season, source, datetime, power) %>%
  pivot_wider(names_from = source, values_from = power) %>%
  ggplot(aes(era, hobo, col = season)) +
  geom_point() +
  geom_smooth(method = "lm", formula = " y ~ x") +
  theme_bw() +
  scale_color_manual("Period", values = c("#816768", "#68ae72")) +
  xlab("ERA5-Land temperature [째C]") +
  ylab("HOBO temperature [째C]") +
  coord_equal() +
  theme(legend.position = "bottom") +
  ggtitle("Frequency 24h")
```

This is the second function which return variance over a period or energy dissipation

```{r}
fc_all %>%
  group_by(source, season, datetime) %>%
  summarise(energy = fft_energy(coefficient)) %>%
  pivot_wider(names_from = source, values_from = energy) %>%
  ggplot(aes(era, hobo, col = season)) +
  geom_point() +
  geom_smooth(method = "lm", formula = " y ~ x") +
  theme_bw() +
  scale_color_manual("Period", values = c("#816768", "#68ae72")) +
  xlab("ERA5-Land energy") +
  ylab("HOBO energy") +
  coord_equal() +
  theme(legend.position = "bottom") +
  ggtitle("Energy")
```

```{r}
fc_all %>%
  group_by(source, season, datetime) %>%
  summarise(energy = fft_energy(coefficient)) %>%
  pivot_wider(names_from = source, values_from = energy) %>%
  ggplot(aes(season, hobo / era, fill = season)) +
  geom_boxplot() +
  theme_bw() +
  scale_fill_manual(guide = "none", values = c("#816768", "#68ae72")) +
  ylab("") +
  xlab("") +
  coord_equal() +
  theme(legend.position = "bottom") +
  ggtitle("Energy HOBO / ERA5-Land")
```
